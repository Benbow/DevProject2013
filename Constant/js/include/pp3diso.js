/**
 * pp3Diso
 * http://www.prelude-prod.fr
 *
 * @author Jean-François RENAULD
 * @version 2
 * Cette oeuvre est mise à disposition selon les termes de la Licence Creative Commons Paternité - Partage à l'Identique 3.0 non transcrit.
 * http://creativecommons.org/licenses/by-sa/3.0/deed.fr
 *
 * Si vous utilisez ce plugin, vous devez mettre un lien retour vers le site : http://www.prelude-prod.fr
 *
 * Date: Fri Mar 12 15:57:00 UTC 2013
 */
(function(a){a.fn.pp3Diso=function(a4){var a4=a.extend({CSSid:"",mapId:1,map:"",mapZones:"",mapZonesColors:"",zone:"",tx:0,ty:0,ty2:0,zoom:1,positionFixe:false,pathfinding:false,PF_corners:true,cursorPF:"",cursorZindex:0,PF_decx:0,PF_decy:0,mousewheel:false,zoom_min:0.25,zoom_max:10,zoom_pas:0.5,fluide:true,nbrTitleSetsSlide:1,auto_resize:true,mode2d:false,mode2d_viewx:5,mode2d_viewy:5,mode2d_select:"#FBE6C1",mode2d_select_off:"#F47070",mode2d_fond:"#ffffff",titre_map:{},titre_case:"",mode2d_avatar:"Avatar",move_avatar_speed:50,bulle_auto_x:true,bulle_auto_y:"top",bulle_obj_deca_y:6,keys:true,keys_tab:{key_n:[38,104],key_ne:[105],key_e:[39,102],key_se:[99],key_s:[40,98],key_so:[97],key_o:[37,100],key_no:[103],key_zoom:[33],key_dezoom:[34],key_clic:[32,101]},prefix:"map-",path:"images/",fogofwar:0,speed_avatar:250,speed_map:100,speed_map_while:100,speed_by_titleset:1,drag:true,onmoveavatar:function(bo,bq,bp){},beforemoveavatar:function(bo,bp){return true},beforeclosewin:function(bp,bo){return true},afterclosewin:function(bp,bo){},onenterbuilding:function(bo,bq,bp){},onleavebuilding:function(bo,bq,bp){},onenterobject:function(bo,bq,bp){},onleaveobject:function(bo,bq,bp){},onclicbuilding:function(bo,bq,bp){},onclicobject:function(bo,bq,bp){},onchangezoom:function(bo){}},a4);var j=a(this);var d=this;var aj=("ontouchstart" in window);if(a4.positionFixe==true){a4.drag=false}a4.ty2=(a4.tx>>2);var n=1;var e=0;var c=0;var al=0;var V=0;if(a4.mode2d){mousewheel=false}var v;var Q=a4.tx;var P=a4.ty;var at=a4.ty2;var ai="";var aD=0;var aA=0;var bm=1;var bk=1;var q,bd,aC;var a0,aZ;var af=0;var ae=0;var au=null;var A=[];var aS=[];var Y=false;var N,M;var m="";var az="";var a9=0;var a8=0;var T=0;var R=0;var am=false;var ag;var bi=false;var ap=false;var w;var a3=[];var Z;var aR;var bf=false;var L,bj,J,K,ab,I,E;var G,D,aI,ak,aK,aJ,C;var bg=[];var ao,bl,aq;var ad,ac,H;var ax,av;var an=false;var r,p;var aY=false;var a1=0;move_map_waiting=false;aL();var z;function aL(){v=~~(a4.zoom*100)+"%";a4.tx=Q*a4.zoom;a4.ty=P*a4.zoom;a4.ty2=at*a4.zoom;bf=false;ad=j.width();ac=j.height();if(a4.zone=="undefined"){a4.zone=""}var bv=j.children(".pp3diso_users").detach();j.children().remove().empty();j.append(bv);a(".pp3diso_users").css({"z-index":760000});if(!a4.mode2d){j.append('<div id="pp3Diso-wait"></div>');Z=a("#pp3Diso-wait")}bj=a4.map.split(":");if(a4.zone!=""){var bu=a4.zone.split(":")}L=a4.path+a4.prefix;dummy=bj[0].split(",");J=bj.length;K=dummy.length;w=new Array(K);for(bo=0;bo<J;bo++){w[bo]=new Array(J)}aI=(a4.tx>>1);ak=a4.ty2;aK=K*(a4.tx);aJ=J*(ak<<1)+(a4.ty2);C=aK>>1;if(a4.mapZones!=""){var bq=a4.mapZones.split(":")}ab=new Array(J);I=new Array(J);E=new Array(J);z=new Array(J);ao=new Array(J);G=0;D=0;ah();for(var bt=1;bt<=J;bt++){E[bt]=new Array(K);ab[bt]=new Array(K);ao[bt]=new Array(K);I[bt]=new Array(K);z[bt]=new Array(K);var bs=bj[bt-1].split(",");if(a4.zone!=""){var br=bu[bt-1].split(",")}if(a4.mapZones!=""){var bp=bq[bt-1].split(",")}for(var bo=1;bo<=K;bo++){E[bt][bo]=~~(bs[bo-1]);if(a4.fogofwar>0){I[bt][bo]=0}else{I[bt][bo]=1}f(bo,bt);if(a4.zone!=""){ab[bt][bo]=~~(br[bo-1])}else{if(E[bt][bo]>0){ab[bt][bo]=1}else{ab[bt][bo]=0}}if(a4.mapZones!=""){ao[bt][bo]=(bp[bo-1]|0)}else{ao[bt][bo]=0}}}if(a4.auto_size){j.css({width:aK,height:aJ})}e=((ad-aK)>>1);c=((ac-aJ)>>1);al=e;V=c;aP(E);ba((K|0),(J|0));aU(E);a("#ppISO").bind("mouseenter",function(){a("#ppISO").focus()});a("#ppISO").focus()}function aP(bJ){N=0;M=0;var bB="";var bE=[0,ak,aI,0,a4.tx,ak,aI,ak<<1];var bF=(a4.zoom<<3);var bD=(bF>>1);var bt=[-bF,ak,aI,-bD,a4.tx+bF,ak,aI,(ak<<1)+bD];if(a("#pp3Diso-conteneur").length==0){j.append('<div id="pp3Diso-conteneur"></div>')}a(".pp3diso").unbind("keyup");H=a("#pp3Diso-conteneur");if(!a4.mode2d){H.css({display:"block",position:"absolute",top:9999,left:9999,width:aK,height:aJ})}if(a4.mousewheel){aa()}var bz=a4.mapZonesColors.split(":");if(!a4.mode2d&&a4.mapZones!=""&&a("#pp3Diso-mapZone").length==0){H.append('<div id="pp3Diso-mapZone"></div>');var br=bz.length;bl=new Array(br);aq=new Array(br);var bK=new Array(br);for(var bG=0;bG<br;bG++){bK[bG]=document.createElement("canvas");bK[bG].id="pp3Diso-mapZone-canvas-"+bG;a("#pp3Diso-mapZone").append(bK[bG]);bl[bG]=a("#pp3Diso-mapZone-canvas-"+bG)[0];aq[bG]=bl[bG].getContext("2d");bl[bG].width=aK;bl[bG].height=aJ;a("#pp3Diso-mapZone-canvas-"+bG).css({display:"none",position:"absolute",top:0,left:0,"z-index":299000,"-moz-opacity":0.5,opacity:0.5,filter:"alpha(opacity=50)"})}a("#pp3Diso-mapZone").css({display:"block",position:"absolute",top:0,left:0,width:aK,height:aJ,"z-index":299000})}if(!a4.mode2d){Z.css("display","block")}if(a("#pp3Diso-bulle").length==0){H.append('<div id="pp3Diso-bulle"></div>')}aR=a("#pp3Diso-bulle");aR.css("display","none");var bI="pp3diso-Map-"+n;n++;var bu='<map name="'+bI+'" id="'+bI+'">';for(var by=1;by<=J;by++){for(var bA=1;bA<=K;bA++){bB="c_"+by+"_"+bA;var bw=bh(by,bA);var bx=u(by,bA);z[by][bA]=new Array(2);z[by][bA][0]=(bx|0);z[by][bA][1]=(bw|0);if(a4.mapZones!=""&&!a4.mode2d){if(ao[by][bA]>0){var bC=ao[by][bA]-1;aq[bC].fillStyle=bz[bC];aq[bC].beginPath();aq[bC].moveTo(~~(bt[0]+bx),~~(bt[1]+bw));var bs=bE.length-1;for(var bH=2;bH<bs;bH+=2){aq[bC].lineTo(~~(bt[bH]+bx),~~(bt[bH+1]+bw))}aq[bC].closePath();aq[bC].fill()}}if(a4.mode2d){}else{var bv="";var bs=bE.length;for(var bG=0;bG<bs;bG+=2){var bq=~~((bE[bG])+bx);var bp=~~((bE[bG+1])+bw);bv+=","+bq+","+bp}bv=bv.substring(1);var bo="s_"+by+"_"+bA;bv='<area id="'+bo+'" class="pp3diso-shap" shape="poly" coords="'+bv+'" alt="" />';bu+=bv}}}if(!a4.mode2d){bu+="</map>";H.prepend('<div id="pp3diso-clicks"><img src="images/vide.gif" id="pp3diso-mapControl" width="'+aK+'" height="'+aJ+'" alt="" />'+bu+"</div>");a("#pp3diso-mapControl").attr("usemap","#"+bI);a("#pp3diso-clicks").css({"z-index":750000,position:"absolute",left:0,top:0,display:"block"})}if(a4.keys){a(window).keyup(function(bR){var bM=T;var bS=R;var bP=false;var bL=null;for(var bQ in a4.keys_tab){for(var bO in a4.keys_tab[bQ]){if(a4.keys_tab[bQ][bO]==bR.keyCode){bL=bQ;bP=true;break}}}switch(bL){case"key_n":bS--;break;case"key_ne":bS--;bM++;break;case"key_e":bM++;break;case"key_se":bS++;bM++;break;case"key_s":bS++;break;case"key_so":bS++;bM--;break;case"key_o":bM--;break;case"key_no":bS--;bM--;break;case"key_clic":if(aX(bM,bS)){B(bM,bS,true)}break;case"key_zoom":b(a4.zoom+a4.zoom_pas);break;case"key_dezoom":b(a4.zoom-a4.zoom_pas);break}if(bP){if(!a4.mode2d){var bN=a("#s_"+bS+"_"+bM);if(bN.length){a6(bN)}}else{var bN=a("#c_"+bS+"_"+bM);if(bN.length){a6(bN)}}}if(bP===true){bR.stopPropagation();bR.preventDefault();return}else{return false}})}if(!a4.mode2d){a(".pp3diso-shap").bind("click",(function(){if(window.Touch){a6(a(this))}if(!aY){aN(a(this))}}));if(!aj){a(".pp3diso-shap").bind("mouseenter",function(){a6(a(this))})}}if(a4.drag&&!a4.mode2d){a("#pp3Diso-conteneur").bind("touchstart",function(bM){aY=false;var bN=bM.originalEvent;var bL=H.position();r=bN.changedTouches[0].clientX-bL.left;p=bN.changedTouches[0].clientY-bL.top;a("#pp3Diso-conteneur").bind("click",function(){return false});a("#pp3Diso-conteneur").bind("touchmove",function(bO){a7(bO)});a("#pp3Diso-conteneur").bind("touchend touchcancel",function(bO){bn(bO,a(this))});if(!ap){ap=true;setTimeout(function(){ap=false},100)}});a(".pp3diso-shap").bind("mousedown",function(bN){aY=false;var bL=bN||window.event;var bM=H.position();r=bL.clientX-bM.left;p=bL.clientY-bM.top;a("#pp3Diso-conteneur").bind("click",function(){return false});a("#pp3Diso-conteneur").bind("mousemove",aB).bind("mouseup",bn);return false})}j.focus()}function aB(br){br.preventDefault();aY=true;var bq=br||window.event;var bp=bq.clientX-r;var bo=bq.clientY-p;if(bo>(a4.ty<<1)){bo=a4.ty<<1}if(bp>(a4.tx)){bp=a4.tx}if(bp<-((aK-ad)+a4.tx)){bp=-((aK-ad)+a4.tx)}if(bo<-((aJ-ac)+a4.ty)){bo=-((aJ-ac)+a4.ty)}H.css({left:bp,top:bo});return false}function bn(bu,bs){var bt=H.position();var bp=~~(-bt.left/a4.tx);var bo=~~(-bt.top/a4.ty);var br=e;var bq=c;e=bt.left;c=bt.top;a("#pp3Diso-conteneur").unbind("mousemove",aB).unbind("mouseup",bn);if(br!=e&&bq!=c){aU(E)}a(".pp3diso-shap").unbind("touchmove");a(".pp3diso-shap").unbind("ontouchend");if(ap){ap=false;aN(bs)}return false}function a7(bq){bq.preventDefault();aY=true;var br=bq.originalEvent;var bp=br.changedTouches[0].clientX-r;var bo=br.changedTouches[0].clientY-p;if(bo>(a4.ty<<1)){bo=a4.ty<<1}if(bp>(a4.tx)){bp=a4.tx}if(bp<-((aK-ad)+a4.tx)){bp=-((aK-ad)+a4.tx)}if(bo<-((aJ-ac)+a4.ty)){bo=-((aJ-ac)+a4.ty)}H.css({left:bp,top:bo});return false}function aa(){var bp=["DOMMouseScroll","mousewheel"];if(this.addEventListener){for(var bo=bp.length;bo;){j[0].addEventListener(bp[--bo],bb,false)}}else{j[0].onmousewheel=bb}}var aV=0;function bb(bt){var bv=new Date();bt.preventDefault();bt.stopPropagation();var br=bt||window.event,bq=[].slice.call(arguments,1),bu=0,bs=true,bp=0,bo=0;bt=a.event.fix(br);bt.type="mousewheel";if(br.wheelDelta){bu=br.wheelDelta/120}if(br.detail){bu=-br.detail/3}bo=bu;if(br.axis!==undefined&&br.axis===br.HORIZONTAL_AXIS){bo=0;bp=-1*bu}if(br.wheelDeltaY!==undefined){bo=br.wheelDeltaY/120}if(br.wheelDeltaX!==undefined){bp=-1*br.wheelDeltaX/120}bq.unshift(bt,bu,bp,bo);if((bv.valueOf()-aV)>1000){if(bq[1]<0){b(a4.zoom-a4.zoom_pas)}else{b(a4.zoom+a4.zoom_pas)}aV=bv.valueOf()}return false}function t(){if(!a4.mode2d){for(var br=1;br<=J;br++){for(var bo=1;bo<=K;bo++){id="c_"+br+"_"+bo;var bp=g(br,bo)+c;var bq=h(br,bo)+e;if(bq>-tx&&bq<(ad+tx)&&bp>-ty&&bp<(ac+ty)){H.append('<div id="'+id+'" class="pp3diso-sol"></div>');a("#"+id).css({"z-index":aQ(br,bo),position:"absolute",left:(bq|0),top:(bp|0),width:a4.tx,height:a4.ty,display:"block"})}}}}}function O(){if(a4.mode2d){aU(E)}if(a1==0&&!a4.mode2d){if(move_map_waiting){H.css("display","none")}move_map_waiting=false;bi=true;if(a4.positionFixe==true){H.animate({left:(al|0),top:(V|0)},a4.speed_map,function(){aU(E);bi=false;H.fadeIn("100");Z.css("display","none")})}else{if(a4.fluide){H.animate({left:(e|0),top:(c|0)},a4.speed_map,function(){aU(E);bi=false;H.fadeIn("100");Z.css("display","none")})}else{H.css({left:(e|0),top:(c|0)});aU(E);bi=false;Z.css("display","none")}}}else{move_map_waiting=true}}function bc(bo,bp){if(!a4.mode2d){bo=(bo|0);bp=(bp|0);id="c_"+bp+"_"+bo;a("#"+id).fadeTo(0,I[bp][bo]);id="b_"+bp+"_"+bo;a("#"+id).fadeTo(0,1);id="o_"+bp+"_"+bo;a("#"+id).fadeTo(0,1)}}function ay(bw,bv,bq){bw=(bw|0);bv=(bv|0);bq=(bq|0);if(bv<1||bw<1||bv>J||bw>K){return}if(I[bv][bw]<bq){I[bv][bw]=bq}if(I[bv][bw]>1){I[bv][bw]=1}bc(bw,bv);var bp=a4.fogofwar;for(var bo=bw-bp;bo<=bw+bp;bo++){var bs=Math.abs(bo-bw);for(var bu=bv-bp;bu<=bv+bp;bu++){var bt=Math.abs(bu-bv);if(bs>bt){bt=bs}if(bo!=bw||bu!=bv){if(!(bu<1||bo<1||bu>J||bo>K)){var br=(bq/bt);if(I[bu][bo]<br){I[bu][bo]=br}if(I[bu][bo]>1){I[bu][bo]=1}bc(bo,bu)}}}}}function aU(bJ){var bA="";var bo="";var bH=a4.tx*3;var bt=a4.ty*3;if(T<1){T=1}if(R<1){R=1}if(a4.mode2d){var by=(T|0)-(a4.mode2d_viewx|0);var bv=(T|0)+(a4.mode2d_viewx|0);if(by<1){bv=bv-(by-1)}if(bv>K){by=K-(((a4.mode2d_viewx|0)<<1))}var bw=(R|0)-(a4.mode2d_viewy|0);var bu=(R|0)+(a4.mode2d_viewy|0);if(bw<1){bu=bu-(bw-1)}if(bu>J){bw=J-(((a4.mode2d_viewy|0)<<1))}if(by<1){by=1}if(bv>K){bv=K}if(bw<1){bw=1}if(bu>K){bu=J}}var bs=ad+bH;var bq=ac+bt;for(var bD=1;bD<=J;bD++){if(a4.mode2d){if(bD>=bw&&bD<=bu){bo=bo+'<tr><th id="y'+bD+'" axis="axe des ordonn�es">'+bD+"</th>"}}var bp="c_"+bD;for(var bE=1;bE<=K;bE++){var bC=z[bD][bE][0];var bB=z[bD][bE][1];var bz=bC+e;var bG=bB+c;var bF=bp+"_"+bE;var br=a("#"+bF);if(a4.mode2d){if(bE>=by&&bE<=bv&&bD>=bw&&bD<=bu){bo=bo+'<td headers="x'+bE+" y"+bD+'" id="'+bF+'"></td>'}}else{if(bz>-bH&&bz<(bs)&&bG>-bt&&bG<(bq)){if(br.length==0){bo=bo+'<div id="'+bF+'" class="pp3diso-sol"></div>'}else{if(a4.fogofwar>0){bc(bE,bD)}if(br[0].getAttribute("display")!="block"){br.css("display","block")}}}else{br.remove().empty()}}}if(a4.mode2d){if(bD>=bw&&bD<=bu){bo=bo+"</tr>"}}}if(a4.mode2d){totalFrag_dummy='<table id="pp3diso_table">';totalFrag_dummy=totalFrag_dummy+"<tr><td>&nbsp;</td>";for(bE=by;bE<=bv;bE++){totalFrag_dummy=totalFrag_dummy+'<th id="x'+bE+'" axis="axe des abscisses">'+bE+"</th>"}totalFrag_dummy=totalFrag_dummy+"</tr>";bo=totalFrag_dummy+bo+"</table>";a("#pp3diso_table").remove()}H.append(bo);var bx="100%";for(var bD=1;bD<=J;bD++){for(var bE=1;bE<=K;bE++){var bC=h(bD,bE);var bB=g(bD,bE);var bz=bC+e;var bG=bB+c;var bF="c_"+bD+"_"+bE;var br=a("#"+bF);if(a4.mode2d){var bI=aG(bE,bD,bJ);br.html(bI).click(function(){var bK=a(this).attr("id");var bM=bK.split("_");var bN=bM[2];var bL=bM[1];if(aX(bN,bL)){B(bN,bL,true)}a6(a(this))}).mouseover(function(){a6(a(this))})}else{if(bz>-bH&&bz<(ad+bH)&&bG>-bt&&bG<(ac+bt)){if(!br.length==0){bA=bJ[bD][bE]+".png";if(bA!="NaN.png"){bA=L+bA;br.css({"z-index":aQ(bD,bE),position:"absolute",left:(bC|0),top:(bB|0),width:a4.tx,height:a4.ty,"background-image":"url('"+bA+"')",display:"block","-webkit-background-size":bx+" "+bx,"-o-background-size":bx+" "+bx,"-moz-background-size":bx+" "+bx,"background-size":bx+" "+bx})}}}}}}}function aG(bo,bt,bs){var br="<p>";var bq="";var bp=" ";if(a4.titre_case!=""){bq=a4.titre_case;bq=aH(bq,"[x]",bo);bq=aH(bq,"[y]",bt)}br=""+bq+bp;br=br+""+a4.titre_map[bs[bt][bo]]+bp;bq=aE(bo,bt);if(bq!=""){br=br+""+bq+bp}if(bm==bo&&bk==bt){br=br+""+a4.mode2d_avatar+bp}br=br+"</p>";return br}function aH(bq,bp,bo){SRRi=bq.indexOf(bp);SRRr="";if(SRRi==-1){return bq}SRRr+=bq.substring(0,SRRi)+bo;if(SRRi+bp.length<bq.length){SRRr+=aH(bq.substring(SRRi+bp.length,bq.length),bp,bo)}return SRRr}function aQ(bp,bo){return(bo<<1)+(bp<<1)}function u(bq,bo){bo=bo|0;bq=bq|0;var bp=C+((bo-1)*aI);bp=bp-(aI*(bq+1))+aI;return(bp|0)}function bh(bq,bo){bo=bo|0;bq=bq|0;var bp=(bq-1)*(ak);bp=bp+(ak*(bo-1));return(bp|0)}function h(bp,bo){return z[bp|0][bo|0][0]}function g(bp,bo){return z[bp|0][bo|0][1]}function U(bo){return(bo|0)}function aF(bo,bq){for(var bp in bg){if(bg[bp]["x"]==bo&&bg[bp]["y"]==bq){return true}}return false}function aE(bo,bs,bq){if(typeof(bq)=="undefined"){bq=" / "}var br="";for(var bp in bg){if(bg[bp]["x"]==bo&&bg[bp]["y"]==bs){br=br+bq+bg[bp]["titre"]}}br=br.substr(bq.length);return br}function a6(bq){var br=bq.attr("id");if(typeof(br)=="undefined"){return}var bt=br.split("_");var bp=bt[2];var bv=bt[1];if(bf){if(T!=bp||R!=bv){if(ab[R][T]==2){a4.onleavebuilding(T,R,a4.mapId)}else{if(aF(T,R)){a4.onleaveobject(T,R,a4.mapId)}}}}T=bp;R=bv;var bo=h(bv,bp)+(a9*a4.zoom);var bu=g(bv,bp)+(a8*a4.zoom);if(aX(bp,bv)){a("#pp3diso-cursor-img").attr("src",m);color_m2d=a4.mode2d_select}else{a("#pp3diso-cursor-img").attr("src",az);color_m2d=a4.mode2d_select_off}if(!a4.mode2d){if(a4.cursorZindex>0){var bs=300000+aQ(bv|0,bp|0)+(a4.cursorZindex|0);a("#pp3diso-cursor").css({display:"block",left:bo,top:bu,"z-index":bs})}else{a("#pp3diso-cursor").css({display:"block",left:bo,top:bu})}}else{a("#pp3diso_table td").css("background-color",a4.mode2d_fond);bq.css("background-color",color_m2d);bq.first("p").focus()}if(ab[bv][bp]==2){a4.onenterbuilding(bp,bv,a4.mapId)}else{if(aF(bp,bv)){a4.onenterobject(bp,bv,a4.mapId)}}}var aT=false;function aw(){if(!aT){a3=null;a3=[];for(y=0;y<J;y++){for(x=0;x<J;x++){if(ab[y+1][x+1]==1){w[x][y]=1}else{w[x][y]=0}}}}}function a2(bo,bu){var bt=bm;var bs=bk;var bq=bo;var bp=bu;aw();var br=astar(bt-1,bs-1,bq-1,bp-1,w,a4.PF_corners);if(br!=null){aO(br);return true}else{return false}}function a5(bz,by,bs){var bB=bm;var bA=bk;var bx=bz;var bw=by;var bt,br,bq,bp;aw();var bC=astar(bB-1,bA-1,bx-1,bw-1,w,a4.PF_corners);if(bC!=null){var bv=bC.length;for(var bE=0;bE<bv;bE++){var bF=h(bC[bE].col+1,bC[bE].row+1);var bD=g(bC[bE].col+1,bC[bE].row+1);var bH=a4.tx>>1;var bu=a4.ty>>1;if(!a4.beforemoveavatar(bz,by)){return}if(bE<1){bt=bm;br=bk}else{bt=bC[bE-1].row+1;br=bC[bE-1].col+1}bq=bC[bE].row+1;bp=bC[bE].col+1;var bo=1;if(bq>bt){bo=3}else{if(bq<bt){bo=2}else{if(bp>br){bo=1}else{if(bp<br){bo=4}else{bo=1}}}}if(bE<1){ae=bo}else{A.push(bo)}bm=bz;bk=by;a3.push(bC[bE].col+1+","+bC[bE].row+1);var bG=a("#pp3diso-avatar");aS.push(300000+aQ(bC[bE].col+1,bC[bE].row+1));bG.animate({left:bF+aD,top:bD+aA},{step:function(){au++;if(au>a4.move_avatar_speed){X();au=0}},duration:a4.speed_avatar,complete:function(){if(A.length){ae=A.shift()}var bJ=a3.pop();var bI=aS.shift();if(aS.length<=1){}bG.css("z-index",bI)}});if(a4.fogofwar>0){ay(bz,by,1)}}}if(bs){a4.onmoveavatar(bz,by,a4.mapId)}}function X(){if(Y){var bo=~~((a0*(af))*a4.zoom);var bp=~~((aZ*(ae-1))*a4.zoom);a("#pp3diso-avatar-img").css({left:-bo,top:-bp});af++;if(af>=aC){af=0}}}function aO(bt){a(".pp3Diso_PF").remove().empty();var bs=bt.length;for(var br=0;br<bs;br++){var bo=h(bt[br].col+1,bt[br].row+1);var bv=g(bt[br].col+1,bt[br].row+1);var bu="pp3Diso_PF_"+bo+"-"+bv;var bq='<div id="'+bu+'" class="pp3Diso_PF"></div>';H.append(bq);var bp="100%";a("#"+bu).css({position:"absolute",display:"block",width:a4.tx,height:a4.ty,"background-image":"url('"+a4.cursorPF+"')","-webkit-background-size":bp+" "+bp,"-o-background-size":bp+" "+bp,"-moz-background-size":bp+" "+bp,"background-size":bp+" "+bp,left:bo+a4.PF_decx,top:bv+a4.PF_decy,"z-index":300000+bt[br].col+1+bt[br].row+1})}}function aX(bo,bq){if(a4.pathfinding){return a2(bo,bq)}else{var bp=false;if(ai==""){bp=true}else{bo=(bo|0);bq=(bq|0);if(bo>=bm-1&&bo<=bm+1&&bq>=bk-1&&bq<=bk+1){bp=true}else{bp=false}}if(ab[bq][bo]==1&&bp){return true}else{return false}}}function B(bw,bv,by){bw=(bw|0);bv=(bv|0);var bu=h(bv,bw);var bt=g(bv,bw);var br=a4.tx>>1;var bz=a4.ty>>1;if(a4.pathfinding){a5(bw,bv,by)}else{if(!a4.beforemoveavatar(bw,bv)){return}if(!a4.mode2d){var bs=a("#pp3diso-avatar");bs.animate({left:bu+aD,top:bt+aA},a4.speed_avatar);bs.css({"z-index":300000+aQ(bv,bw)})}bm=bw;bk=bv;if(a4.fogofwar>0){ay(bw,bv,1)}if(by){a4.onmoveavatar(bw,bv,a4.mapId)}}modif_move=false;if(ad<aK+(a4.tx>>1)){var bq=a4.nbrTitleSetsSlide*a4.tx;var bo=~~(bu+e+br);var bp=((ad>>1)+bq);if(bo>bp){while(bo>bp){e-=bq;bo=~~(bu+e+br)}modif_move=true}bp=((ad>>1)-bq);if(bo<bp){while(bo<bp){e+=bq;bo=~~(bu+e+br)}modif_move=true}}if(ac<aJ+(a4.ty>>1)){var bq=a4.nbrTitleSetsSlide*a4.ty;var bo=~~(bt+c+bz);var bp=((ac>>1)+bq);if(bo>bp){while(bo>bp){c-=bq;bo=~~(bt+c+bz)}modif_move=true}bp=((ac>>1)-bq);if(bo<bp){while(bo<bp){c+=bq;bo=~~(bt+c+bz)}modif_move=true}}T=bm;R=bk;if(!a4.mode2d){var bx=a("#s_"+R+"_"+T);if(bx.length){a6(bx)}}else{var bx=a("#c_"+R+"_"+T);a6(bx);modif_move=true}if(modif_move){O()}}function aN(bp){var bq=bp.attr("id");var br=bq.split("_");var bo=br[2];var bs=br[1];aR.css("display","none");if(ab[bs][bo]==2){a4.onclicbuilding(bo,bs,a4.mapId)}else{if(aF(bo,bs)){a4.onclicobject(bo,bs,a4.mapId)}}if(aX(bo,bs)){B(bo,bs,true)}}function F(bo){bo=bo.substring(0,bo.length-2);return(bo|0)}function ah(){a("#pp3diso-avatar").remove().empty()}this.reload=function(bq,bo,br,bp){bg=null;bg=[];aM();bm=1;bk=1;T=1;R=1;a4.map=bq;a4.zone=bo;a4.mapZones=br;a4.mapId=bp;aL();O()};this.show=function(bo){if(!a4.fogofwar>0){}B(bm,bk,bo);H.css("display","none")};this.changeCursor=function(bp,bq,bo,br){a("#pp3diso-cursor").remove().empty();N=0;l(bp,bq,bo,br)};this.cursor=function(bp,bq,bo,br){l(bp,bq,bo,br)};function l(bp,bq,bo,br){m=bp;az=bq;a9=bo;a8=br;if(!a4.mode2d){H.append('<div id="pp3diso-cursor"><img id="pp3diso-cursor-img" src="'+bp+'" alt="" /></div>');a("#pp3diso-cursor-img").load(function(){if(this.width<1){}else{if(N<1){a("#pp3diso-cursor-img").attr("rel",this.width+":"+this.height);N=~~(this.width*a4.zoom);M=~~(this.height*a4.zoom);this.width=N;this.height=M}}});a("#pp3diso-cursor").css({"z-index":299000,position:"absolute",left:0,top:0,display:"block"})}}function ba(bo,br){var bq=h(br,bo);var bp=g(br,bo);e=-((bq-(ad>>1))|0);c=-((bp-(ac>>1))|0);T=bo;R=br;bm=bo;bk=br;if(bi){setTimeout(function(){ba(bo,br)},250)}else{O();H.css("display","block")}}this.moveTo=function(bo,bp){ba(bo,bp)};this.getMonde=function(){var bo=new Array(K+1);for(x=1;x<=K;x++){bo[x]=new Array(J+1);for(y=1;y<=J;y++){bo[x][y]=E[y][x]}}return bo};this.getObjects=function(){return bg};this.getBuilding=function(){var bo=new Array(K+1);for(x=1;x<=K;x++){bo[x]=new Array(J+1);for(y=1;y<=J;y++){bp="";var bq="b_"+y+"_"+x;if(a("#"+bq+" img").length>0){var bp=a("#"+bq+" img").attr("src")}bo[x][y]=bp}}return bo};this.moveObject=function(bo,bw,bu,bp,bs){for(var br in bg){if(bg[br]["id"]==bo){bg[br]["x"]=bw;bg[br]["y"]=bu;var bx=h(bu,bw)+(bg[br]["decx"]*a4.zoom);var bv=g(bu,bw)+(bg[br]["decy"]*a4.zoom);var bq="o_"+bo;if(bp){var bt=300000+aQ(bu,bw);a("#"+bq).css("z-index",bt).animate({left:(bx|0),top:(bv|0)},bs)}else{a("#"+bq).css({"z-index":300000+aQ(bu,bw),left:(bx|0),top:(bv|0)})}break}}};this.killAvatar=function(){ah()};this.avatar=function(bp,bu,br,bo,bt,bq,bs){ar(bp,bu,br,bo,bt,bq,bs)};function ar(bw,bv,bo,bq,bp,br,bu){if(bi){setTimeout(function(){ar(bw,bv,bo,bq,bp,br,bu)},250);return}ah();if(typeof(br)=="undefined"){br=false;bu=1;var bs=1}else{var bs=4}var bt=~~(100*bu)+"%";aD=bq*a4.zoom;aA=bp*a4.zoom;q=bq;bd=bp;bm=bw;bk=bv;aC=bu;Y=br;ai=bo;if(!a4.mode2d){H.append('<div id="pp3diso-avatar"><img id="pp3diso-avatar-img" src="'+bo+'" alt="" /></div>');a("#pp3diso-avatar-img").load(function(){var by=this.width;var bx=this.height;a0=~~(by/bu);aZ=~~(bx/bs);var bA=~~(a0*a4.zoom);var bz=~~(aZ*a4.zoom);var bB=a("#pp3diso-avatar-img");a("#pp3diso-avatar").css({"z-index":300000+aQ(bv,bw),position:"absolute",left:h(bv,bw)+bq,top:g(bv,bw)+bp,width:bA,height:bz,overflow:"hidden",display:"block"});bB.css({position:"absolute",display:"block",left:0,top:0,width:bA*bu,height:bz*bs});B(bm,bk,false)})}else{B(bm,bk,false)}}this.moveAvatarTo=function(bo,bp){bm=bo;bk=bp;B(bo,bp,false)};this.changeOneMap=function(bo,bu,br){var bt="c_"+bu+"_"+bo;var bq=a("#"+bt);var bp="100%";var bs=L+br+".png";E[bu][bo]=br;bq.css({"background-image":"url('"+bs+"')","-webkit-background-size":bp+" "+bp,"-o-background-size":bp+" "+bp,"-moz-background-size":bp+" "+bp,"background-size":bp+" "+bp})};this.changeState=function(bo,bq,bp){ab[bq][bo]=bp};this.getState=function(bo,bp){return ab[bp][bo]};this.getOneMap=function(bo,bp){return E[bp][bo]};this.killBuilding=function(bo,bp){f(bo,bp)};function f(bo,bq){var bp="#b_"+bq+"_"+bo;ab[bq][bo]=1;if(a(bp).length){a(bp).remove().empty()}}this.addBuilding=function(bp,bs,bq,bo,br){aW(bp,bs,bq,bo,br)};function aW(bv,bt,bx,bq,bp){var bs=v;var bw=h(bt,bv)+(bq*a4.zoom);var bu=g(bt,bv)+(bp*a4.zoom);ab[bt][bv]=2;var bo="b_"+bt+"_"+bv;H.append('<div id="'+bo+'" class="pp3diso-batiment"><img src="'+bx+'" alt="" /></div>');var br=a("#"+bo);br.attr("rel",bx+":"+bq+":"+bp);a1++;a("#"+bo+" img").load(function(){var bz=~~(this.width*a4.zoom);var by=~~(this.height*a4.zoom);a(this).attr("rel",this.width+":"+this.height+":"+this.top+":"+this.left);a(this).width(bz).height(by);a1--;if(move_map_waiting){O()}});br.css({"z-index":300000+aQ(bt,bv),position:"absolute",left:(bw|0),top:(bu|0),display:"block"})}function s(){var bp=[];for(var bo in bg){if(bg[bo]["id"]!=""){bp[bo]=[];bp[bo]=bg[bo]}}bg=null;bg=bp}this.killObject=function(bo){S(bo)};function S(bq){var bp="#o_"+bq;for(var bo in bg){if(bg[bo]["id"]==bq){bg[bo]["id"]="";break}}s();if(a(bp).length){a(bp).remove().empty()}}this.addObject=function(bp,bv,bq,bo,bu,bt,br,bs){return W(bp,bv,bq,bo,bu,bt,br,bs)};function W(by,bw,bA,br,bp,bv,bt,bo){var bz=h(bw,by)+(br*a4.zoom);var bx=g(bw,by)+(bp*a4.zoom);if(typeof(bt)=="undefined"){bt=""}dummy=bg.length+1;if(typeof(bo)=="undefined"){bo=dummy}var bs=[];bs.id=bo;bs.x=by;bs.y=bw;bs.sprite=bA;bs.decx=br;bs.decy=bp;bs.titre=bv;bs.bulle=bt;bg.push(bs);if(a4.mode2d){var bo="c_"+bw+"_"+by;var bB=a("#"+bo);if(bv!=""){bB.append("<p>"+bv+" ("+bt+")</p>")}}else{var bq="o_"+bo;a("#"+bq).remove().empty();var bu="";if(bt!=""){bu='<div class="pp3diso-obj-bulle">'+bt+"<div>"}H.append('<div id="'+bq+'" class="pp3diso-objet"><img src="'+bA+'" alt="" />'+bu+"</div>");a("#"+bq).attr("rel",bA+":"+br+":"+bp);a1++;a("#"+bq+" img").load(function(){var bI=~~(this.width*a4.zoom);var bH=~~(this.height*a4.zoom);a(this).width(bI).height(bH);if(bt!=""){var bC=a("#"+bq+" .pp3diso-obj-bulle");if(a4.bulle_auto_x){var bD=bC.outerWidth();var bG=~~(((bI-bD)>>1));bC.css({left:bG})}if(a4.bulle_auto_y=="top"){var bE=bC.height();var bF=-(bE+a4.bulle_obj_deca_y);bC.css({top:bF})}else{if(a4.bulle_auto_y=="bottom"){var bE=bC.height();var bF=-(bE+a4.bulle_obj_deca_y);bC.css({bottom:bF})}}}a1--;if(move_map_waiting){O()}});a("#"+bq).css({"z-index":300000+aQ(bw,by),position:"absolute",left:~~(bz),top:~~(bx),display:"block"})}}function be(){a("#pp3diso-win-fond").fadeTo(500,0,function(){a("#pp3diso-win-fond").remove().empty()});a("#pp3diso-win").remove().empty();a("#pp3diso-clicks").css("display","block")}this.message=function(bq,bz,bw){if(a("#pp3diso-win").length!=0){return}aR.css("display","none");var bv='<div id="pp3diso-win-fond"></div>';bv+='<div id="pp3diso-win"><div id="pp3diso-close"></div><div class="pp3diso-win-texte">'+bz+"</div>";if(bw!=""){var by=bw.split("||");bv+='<div id="pp3diso-win-form">';var bs=by.length;for(var bu=0;bu<bs;bu++){bt=by[bu].split("::");bv+='<a href="#" rel="'+bt[1]+'" class="pp3diso-win-button" id="pp3diso-win-'+bu+'">'+bt[0]+"</a>"}bv+="</div>"}bv+="</div>";j.append(bv);a("#pp3diso-win-0").focus();var bx=a("#pp3diso-win");bt=(ad/3);var bp=(bt<<1);var br=(bt>>1);var bo=-1;a("#pp3diso-win-fond").css({position:"absolute",width:aK,height:aJ,left:0,top:0,"z-index":800000,display:"block"}).fadeTo(0,0.4);bx.css({position:"absolute",width:bp,left:br,top:50,"z-index":800001,display:"none"});bx.slideDown(100);a("#pp3diso-clicks").css("display","none");a("#pp3diso-close").click(function(bA){bA.preventDefault();bA.stopImmediatePropagation();a4.beforeclosewin(0);bx.slideUp("fast",function(){be();a4.afterclosewin(bq,bo)})});if(bw!=""){var by=bw.split("||");var bs=by.length;for(var bu=0;bu<bs;bu++){var bt=by[bu].split("::");a("#pp3diso-win-"+bu).click(function(bB){bB.preventDefault();bB.stopImmediatePropagation();var bA=a(this).attr("rel");a4.beforeclosewin(bA);bx.slideUp("fast",function(){be();a4.afterclosewin(bq,bA)})})}}};this.zoomMap=function(bo){b(bo)};function aM(){a("#pp3diso-clicks").remove().empty();a("#pp3diso-Map").remove().empty();if(a4.mapZonesColors!=""){var bo=a4.mapZonesColors.split(":");var bp=bo.length;for(i=0;i<bp;i++){aq[i].clearRect(0,0,bl[i].width,bl[i].height)}a("pp3Diso-mapZone").remove().empty()}}function b(bp){a("#pp3diso-avatar").clearQueue();A=null;A=[];aS=null;aS=[];a(".pp3Diso_PF").remove().empty();if(bp<a4.zoom_min){bp=a4.zoom_min}if(bp>a4.zoom_max){bp=a4.zoom_max}aM();var bs=a4.zoom;a4.zoom=bp;var bx=bs-bp;var bA=e-((e*bx)|0);var bF=c-((c*bx)|0);e=bA;c=bF;v=~~(a4.zoom*100)+"%";a4.tx=Q*a4.zoom;a4.ty2=(a4.tx>>1);a4.ty=P*a4.zoom;a4.ty2=at*a4.zoom;aI=(a4.tx>>1);ak=a4.ty2;aK=~~(K*(a4.tx));aJ=~~(J*(ak<<1)+(a4.ty2));C=(aK>>1);al=((ad-aK)>>1);V=((ac-aJ)>>1);if(a4.mapZonesColors!=""){var bv=a4.mapZonesColors.split(":");var br=bv.length;for(bD=0;bD<br;bD++){bl[bD].width=aK;bl[bD].height=aJ}}if(a4.auto_size){j.css({width:aK,height:aJ})}aP(E);if(!a4.mode2d){Z.css("display","block")}aU(E);var bE=[];bE=bg;bg=null;bg=[];for(var bD in bE){if(bE[bD]["id"]!=""){var by="o_"+bE[bD]["id"];a("#"+by).remove().empty();W(bE[bD]["x"],bE[bD]["y"],bE[bD]["sprite"],bE[bD]["decx"],bE[bD]["decy"],bE[bD]["titre"],bE[bD]["bulle"],bE[bD]["id"])}}for(var bu=1;bu<=J;bu++){for(var bw=1;bw<=K;bw++){if(ab[bu][bw]==2){var by="b_"+bu+"_"+bw;bE=(a("#"+by).attr("rel")).split(":");a("#"+by).remove().empty();aW(bw,bu,bE[0],bE[1],bE[2])}}}var bo=a("#pp3diso-cursor-img");if(!bo.length==0){var bE=bo.attr("rel").split(":");N=~~(bE[0]*a4.zoom);M=~~(bE[1]*a4.zoom);bo.attr("width",N).attr("height",M)}var bC=a("#pp3diso-avatar-img");if(!(bC.length==0)){if(Y){nbr_x=4}else{nbr_x=1}var bq=~~(100*aC)+"%";var bB=~~((a0*aC*a4.zoom)/aC);var bz=~~((aZ*a4.zoom));var bt=a("#pp3diso-avatar-img");a("#pp3diso-avatar").css({width:bB,height:bz});bt.css({position:"absolute",overflow:"hidden",display:"block",left:0,top:0,width:bB*aC,height:bz*nbr_x})}aD=q*a4.zoom;aA=bd*a4.zoom;var bE=a4.speed_avatar;a4.speed_avatar=1;B(bm,bk);a4.speed_avatar=bE;O();a4.onchangezoom(bp)}this.moveMapOn=function(){var bq=["s","n","e","o","se","so","ne","no"];var bp=bq.length;for(var bo=0;bo<bp;bo++){var br="#pp3diso-fleche-"+bq[bo];if(a(br).length){a(br).bind("mouseover",function(){var bs=a(this).attr("id");bs=bs.substr(15);if(!am){am=true;k(bs,a4.speed_by_titleset)}});a(br).bind("mouseout",function(){o()})}}};function k(bq,br){if(bi){return}var bo=(a4.ty>>1)*br;var bp=(a4.tx>>1)*br;switch(bq){case"n":c+=bo;break;case"ne":c-=bo;e-=bp;break;case"e":e-=bp;break;case"se":e-=bp;c+=bo;break;case"s":c-=bo;break;case"so":c+=bo;e+=bp;break;case"o":e+=bp;break;case"no":c-=bo;e+=bp;break}if(e<-(aK-ad)){e=-(aK-ad)}if(e>0){e=0}if(c<-(aJ-ac)){c=-(aJ-ac)}if(c>0){c=0}O();if(am){clearInterval(ag);ag=setInterval(function(){if(am&&!bi){k(bq,br)}},a4.speed_map_while)}}this.moveMapOne=function(bo,bp){k(bo,bp)};this.moveMapWhile=function(bo,bp){am=true;k(bo,bp)};function o(){am=false;clearInterval(ag)}this.moveMapStop=function(){o()};this.tipShow=function(br,bp,bo,bq){aR.css({display:"none"});aR.html(br);if(bp==0){bo=h(R,T)+a9+bo;bq=g(R,T)+a8+bq}else{if(bp==1){if(bo<0){bo+=ad;bo-=aR.outerWidth()}if(bq<0){bq+=ac;bq-=aR.outerHeight()}bo-=e;bq-=c}}aR.css({top:bq,left:bo,display:"none"});aR.stop(true,true).fadeIn("normal");bf=true};this.tipHide=function(){aR.stop(true,true).fadeOut("normal",function(){bf=false})};this.toggleZone=function(bp,bq){if(bq==""){bq="normal"}bp--;var bo=a("#pp3Diso-mapZone-canvas-"+bp);if(bo.css("display")=="none"){bo.fadeIn(bq)}else{bo.fadeOut(bq)}};this.showZone=function(bo,bp){if(bp==""){bp="normal"}bo--;a("#pp3Diso-mapZone-canvas-"+bo).fadeIn(bp)};this.hideZone=function(bo,bp){if(bp==""){bp="normal"}bo--;a("#pp3Diso-mapZone-canvas-"+bo).fadeOut(bp)};return this}})(jQuery);var mapLength,mapRowLength;function astar(h,f,j,g,b,d){var k=[];var l=[];var a=[];mapLength=b.length;mapRowLength=b[0].length;var e=new Node(j,g,b,null,null);var m=new Node(h,f,b,null,e);addNodeToList(m,k);var c;while(!isListEmpty(k)){c=returnNodeWithLowestFScore(k);addNodeToList(c,l);removeNodeFromList(c,k);if(areNodesEqual(c,e)){pathTo(c,a);a.reverse();return a}c.makeChildNodes(b,d,e);cullUnwantedNodes(c.childNodes,k);cullUnwantedNodes(c.childNodes,l);removeMatchingNodes(c.childNodes,k);removeMatchingNodes(c.childNodes,l);addListToList(c.childNodes,k)}return null}function pathTo(b,a){a.push(new NodeCoordinate(b.row,b.col));if(b.parentNode==null){return}pathTo(b.parentNode,a)}function addListToList(b,a){for(x in b){a.push(b[x])}}function removeMatchingNodes(d,f){var c=d.length;var e=f.length;for(var b=0;b<c;b++){for(var a=0;a<e;a++){if(f[a].row==d[b].row&&f[a].col==d[b].col){f.splice(a,1);e=f.length}}}}function cullUnwantedNodes(d,a){var e=a.length;var f=d.length;for(var c=0;c<e;c++){for(var b=0;b<f;b++){if(d[b].row==a[c].row&&d[b].col==a[c].col){if(d[b].f>=a[c].f){d.splice(b,1);f=d.length}}}}}function areNodesEqual(b,a){if(b.row==a.row&&b.col==a.col){return true}else{return false}}function returnNodeWithLowestFScore(b){var a=b[0];for(x in b){a=(b[x].f<a.f)?b[x]:a}return a}function isListEmpty(a){return(a.length<1)?true:false}function removeNodeFromList(b,c){var d=c.length;for(var a=0;a<d;a++){if(b.row==c[a].row&&b.col==c[a].col){c.splice(a,1);break}}}function addNodeToList(a,b){b.push(a)}function returnHScore(b,d){var c=b.row-d.row;c=c<0?-c:c;var a=b.col-d.col;a=a<0?-a:a;return(a>c)?(c*14)+10*(a-c):(a*14)+10*(c-a)}function NodeCoordinate(b,a){this.row=b;this.col=a}function Node(d,b,c,a,e){this.row=d;this.col=b;this.northAmbit=(d==0)?0:d-1;this.southAmbit=(d==mapLength-1)?mapLength-1:d+1;this.westAmbit=(b==0)?0:b-1;this.eastAmbit=(b==mapRowLength-1)?mapRowLength-1:b+1;this.parentNode=a;this.childNodes=[];if(a!=null){if(d==a.row||b==a.col){this.g=a.g+10}else{this.g=a.g+14}this.h=returnHScore(this,e)}else{this.g=0;if(c[d][b]=="s"){this.h=returnHScore(this,e)}else{this.h=0}}this.f=this.g+this.h;this.makeChildNodes=function(k,f,l){for(var h=this.northAmbit;h<=this.southAmbit;h++){for(var g=this.westAmbit;g<=this.eastAmbit;g++){if(h!=this.row||g!=this.col){if(k[h][g]!="0"){if(f){this.childNodes.push(new Node(h,g,k,this,l))}else{if(h==this.row||g==this.col){this.childNodes.push(new Node(h,g,k,this,l))}}}}}}}};